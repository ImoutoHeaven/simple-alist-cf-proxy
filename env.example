# ===== Required Environment Variables =====

# ADDRESS (required)
# AList server address
# Example: ADDRESS=https://alist.example.com
ADDRESS=https://your-alist-server.com

# TOKEN (required)
# HMAC-SHA256 signing key for signature verification
# This must match the TOKEN used in alist-landing-worker
# Example: TOKEN=your-super-secret-token-here
TOKEN=your-hmac-token-here

# WORKER_ADDRESS (required)
# Current worker's address (used for redirect loop detection)
# Example: WORKER_ADDRESS=https://download.workers.dev
WORKER_ADDRESS=https://your-worker.workers.dev

# ===== Optional Environment Variables =====

# VERIFY_HEADER (optional)
# Custom verification header name to send to AList
# Leave empty if not needed
VERIFY_HEADER=

# VERIFY_SECRET (optional)
# Custom verification header value to send to AList
# Leave empty if not needed
VERIFY_SECRET=

# SIGN_CHECK (default: true)
# Enable or disable ?sign= parameter verification
# Set to "false" to skip sign verification (NOT RECOMMENDED)
SIGN_CHECK=true

# HASH_CHECK (default: true)
# Enable or disable ?hashSign= parameter verification
# Set to "false" to skip hashSign verification
HASH_CHECK=true

# CHECK_ORIGIN (default: empty)
# Comma-separated fields to enforce origin binding. Supported values:
#   ip, iprange, country, continent, region, city, asn
# Examples:
#   CHECK_ORIGIN=asn
#   CHECK_ORIGIN=country,asn
#   CHECK_ORIGIN=iprange,asn
# Leave empty ("") to disable origin binding globally. Use the skip-origin action
# for per-path overrides when only select routes should bypass the check.
CHECK_ORIGIN=

# IPV4_ONLY (default: true)
# Block IPv6 access and only allow IPv4
# Set to "false" to allow both IPv4 and IPv6
IPV4_ONLY=true

# ===== Path Blacklist/Whitelist Configuration =====

# BLACKLIST_PREFIX (optional)
# Comma-separated list of path prefixes to blacklist
# Paths matching these prefixes will be subject to BLACKLIST_ACTION
# Example: BLACKLIST_PREFIX=/private,/admin,/internal
BLACKLIST_PREFIX=

# BLACKLIST_ACTION (optional)
# Action to take for blacklisted paths. Valid values:
#   - block: Return 403 Forbidden, deny all access
#   - skip-sign: Skip sign verification only
#   - skip-hash: Skip hashSign verification only
#   - skip-worker: Skip workerSign verification only
#   - skip-addition: Skip additionalInfo verification (unless CHECK_ORIGIN requires it)
#   - skip-addition-expiretime: Skip expireTime validation inside additionalInfo
#   - skip-origin: Skip origin binding even if CHECK_ORIGIN is enabled
#   - asis: Respect SIGN/HASH/WORKER/CHECK_ORIGIN global settings
# Example: BLACKLIST_ACTION=block
BLACKLIST_ACTION=

# WHITELIST_PREFIX (optional)
# Comma-separated list of path prefixes to whitelist
# Paths matching these prefixes will be subject to WHITELIST_ACTION
# Example: WHITELIST_PREFIX=/public,/shared,/downloads
WHITELIST_PREFIX=

# WHITELIST_ACTION (optional)
# Action to take for whitelisted paths. Valid values: (same as BLACKLIST_ACTION)
#   - block / skip-sign / skip-hash / skip-worker
#   - skip-addition / skip-addition-expiretime / skip-origin / asis
# Example: WHITELIST_ACTION=skip-origin
WHITELIST_ACTION=

# ===== Database & Cache Configuration =====

# DB_MODE (optional)
# Enable database-backed cache/throttle/rate-limit. Valid: d1, d1-rest, custom-pg-rest
DB_MODE=

# CLEANUP_PERCENTAGE (optional, default: 1)
# Probability (0-100) that cleanup tasks run asynchronously.
CLEANUP_PERCENTAGE=1

# DOWNLOAD_CACHE_TABLE (optional)
# Override the cache table name when using a database backend.
DOWNLOAD_CACHE_TABLE=DOWNLOAD_CACHE_TABLE

# THROTTLE_PROTECTION_TABLE (optional)
# Override the throttle protection table name when using a database backend.
THROTTLE_PROTECTION_TABLE=THROTTLE_PROTECTION

# THROTTLE_PROTECT_HOSTNAME (optional)
# Comma-separated list of hostnames or suffixes that enable throttle protection.
THROTTLE_PROTECT_HOSTNAME=

# THROTTLE_TIME_WINDOW (optional, default: 60s)
# Protection duration after a hostname hits a protected HTTP status code.
THROTTLE_TIME_WINDOW=60s

# THROTTLE_TIME_WINDOW_SECONDS (optional)
# Alternative numeric form (seconds) for protection duration; overrides THROTTLE_TIME_WINDOW when set.
THROTTLE_TIME_WINDOW_SECONDS=

# THROTTLE_PROTECT_HTTP_CODE (optional, default: 429,500,503)
# Comma-separated HTTP status codes that trigger throttle protection.
THROTTLE_PROTECT_HTTP_CODE=429,500,503

# THROTTLE_OBSERVE_WINDOW_SECONDS (optional, default: 60)
# Observation window length for counting successes/errors.
THROTTLE_OBSERVE_WINDOW_SECONDS=60

# THROTTLE_ERROR_RATIO_PERCENT (optional, default: 20)
# Error ratio threshold inside the observation window (only applies when sample count is met).
THROTTLE_ERROR_RATIO_PERCENT=20

# THROTTLE_CONSECUTIVE_THRESHOLD (optional, default: 4)
# Consecutive protected HTTP responses needed to trigger protection (set to 1 to mimic immediate protection).
THROTTLE_CONSECUTIVE_THRESHOLD=4

# THROTTLE_MIN_SAMPLE_COUNT (optional, default: 8)
# Minimal combined sample count (success + error) before ratio-based triggering is evaluated.
THROTTLE_MIN_SAMPLE_COUNT=8

# THROTTLE_FAST_MIN_SAMPLE_COUNT (optional, default: 4; set to 0 to disable fast trigger)
# Minimum sample count threshold for fast ratio triggering (scheme B).
THROTTLE_FAST_MIN_SAMPLE_COUNT=4

# THROTTLE_FAST_ERROR_RATIO_PERCENT (optional, default: 60)
# Fast ratio threshold percentage that applies once fast sample count is reached.
THROTTLE_FAST_ERROR_RATIO_PERCENT=60

# DOWNLOAD_IP_RATELIMIT_TABLE (optional)
# Override the IP rate limit table name when using a database backend.
DOWNLOAD_IP_RATELIMIT_TABLE=DOWNLOAD_IP_RATELIMIT_TABLE

# ===== Rate Limit Configuration (optional) =====
# Leave blank to disable database-backed IP rate limiting.

# WINDOW_TIME
# Time window for IP subnet counting (e.g., 24h, 60m, 30s)
WINDOW_TIME=

# IPSUBNET_WINDOWTIME_LIMIT
# Maximum number of requests allowed per subnet within WINDOW_TIME.
IPSUBNET_WINDOWTIME_LIMIT=

# IPV4_SUFFIX / IPV6_SUFFIX
# CIDR suffix applied before hashing, defaults match /32 (IPv4) and /60 (IPv6).
IPV4_SUFFIX=/32
IPV6_SUFFIX=/60

# BLOCK_TIME (optional, default: 10m)
# Extend block duration once the limit is exceeded.
BLOCK_TIME=10m

# PG_ERROR_HANDLE (optional, default: fail-closed)
# Choose fail-open to skip database operations when connectivity fails.
PG_ERROR_HANDLE=fail-closed

# ===== Notes =====
#
# Signature Check Order: sign → hashSign → workerSign → origin decrypt (when CHECK_ORIGIN is set)
# - Skipping earlier checks automatically skips later ones
#
# Priority: Blacklist > Whitelist > Default (CHECK flags)
# - When a path matches both blacklist and whitelist, blacklist takes precedence
#
# Activation Requirements:
# - Blacklist is ONLY active when BOTH BLACKLIST_PREFIX and BLACKLIST_ACTION are set
# - Whitelist is ONLY active when BOTH WHITELIST_PREFIX and WHITELIST_ACTION are set

# ========================================
# Fair Upstream Queue Configuration
# ========================================
# Enable fair queue to limit concurrent upstream requests per hostname
# Default: false (disabled)
FAIR_QUEUE_ENABLED=false

# Backend: worker (default) or slot-handler
FAIR_QUEUE_BACKEND=worker

# Comma-separated list of hostname patterns to protect
# Supports wildcards: *.sharepoint.com
# Example: contoso1-my.sharepoint.com,*.onedrive.com
FAIR_QUEUE_HOST_PATTERNS=

# Maximum concurrent slots per hostname (global limit)
# Default: 5
FAIR_QUEUE_GLOBAL_LIMIT=5

# Maximum concurrent slots per IP subnet (prevents single IP hogging all slots)
# Default: 1
FAIR_QUEUE_PER_IP_LIMIT=1

# Maximum number of pending queue waiters per hostname/ip subnet combination
# Default: 3
FAIR_QUEUE_MAX_WAITERS_PER_IP=3

# Maximum queue wait time in milliseconds (maxWaitMs)
# Default: 15000 (15 seconds, leaves 15s buffer for 30s Worker timeout)
FAIR_QUEUE_MAX_WAIT_MS=15000

# Zombie slot timeout in seconds (auto-reclaim stuck slots)
# Default: 30
FAIR_QUEUE_ZOMBIE_TIMEOUT_SECONDS=30

# Queue depth zombie timeout in seconds (auto-reset stuck waiters, default 20)
FAIR_QUEUE_QUEUE_DEPTH_ZOMBIE_TTL_SECONDS=20

# Polling interval in milliseconds (D1/D1-REST modes)
# Default: 200
FAIR_QUEUE_POLL_INTERVAL_MS=200

# Minimum slot hold time in milliseconds (approximate QPS limiter)
# Default: 800 (with 4 slots ≈ 5 QPS)
FAIR_QUEUE_MIN_SLOT_HOLD_MS=800

# Fair queue table name
# Default: upstream_slot_pool
FAIR_QUEUE_TABLE_NAME=upstream_slot_pool

# Cooldown time (seconds) before the same IP can re-acquire a slot after release
# Default: 3 (set to 0 to disable cooldown behavior)
FAIR_QUEUE_IP_COOLDOWN_SECONDS=3

# Slot-handler service (when FAIR_QUEUE_BACKEND=slot-handler)
FAIR_QUEUE_SLOT_HANDLER_URL=
FAIR_QUEUE_SLOT_HANDLER_TIMEOUT_MS=
FAIR_QUEUE_SLOT_HANDLER_AUTH_KEY=
